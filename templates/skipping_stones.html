{% extends "base.html" %}

{% block title %}Skipping Stones{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-circle me-2"></i>Game Board
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p class="text-muted">Click a marble to select it, then click a valid destination to make a move.</p>
                        </div>
                        <div class="col-md-6 text-end">
                            <button id="saveBtn" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>Save Game
                            </button>
                            <button id="resetBtn" class="btn btn-warning">
                                <i class="fas fa-redo me-2"></i>Reset Game
                            </button>
                            <button id="undoBtn" class="btn btn-secondary">
                                <i class="fas fa-undo me-2"></i>Undo
                            </button>
                        </div>
                    </div>
                    
                    <div class="game-board-container">
                        <div class="level-indicator">
                            <span class="level-badge">Level: <span id="currentLevel">1</span></span>
                        </div>
                        <div id="gameBoard" class="game-board"></div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-info-circle text-info me-2"></i>Game Rules
                                    </h6>
                                    <ul class="list-unstyled mb-0">
                                        <li><i class="fas fa-check text-success me-2"></i>Click a marble to select it</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Click a valid destination to jump</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Marble must jump over another marble</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Jumped marble is removed</li>
                                        <li><i class="fas fa-check text-success me-2"></i>Goal: Leave only one marble</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <i class="fas fa-trophy text-warning me-2"></i>Game Stats
                                    </h6>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <h4 id="movesCount" class="text-primary">0</h4>
                                            <small class="text-muted">Moves</small>
                                        </div>
                                        <div class="col-4">
                                            <h4 id="marblesLeft" class="text-success">0</h4>
                                            <small class="text-muted">Marbles Left</small>
                                        </div>
                                        <div class="col-4">
                                            <h4 id="gameStatus" class="text-info">Playing</h4>
                                            <small class="text-muted">Status</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-puzzle-piece me-2"></i>Puzzle Configurations
                    </h5>
                </div>
                <div class="card-body">
                    <div id="configurations" class="config-list">
                        <!-- Configurations will be loaded here -->
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-history text-secondary me-2"></i>Move History
                    </h6>
                </div>
                <div class="card-body">
                    <div id="moveHistory" class="move-history">
                        <p class="text-muted text-center">No moves yet</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3" id="userStatsCard" style="display: none;">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-user-chart me-2"></i>Your Progress
                    </h6>
                </div>
                <div class="card-body">
                    <div id="userStats" class="user-stats">
                        <div class="row text-center">
                            <div class="col-6">
                                <h5 id="completedLevels" class="text-success">0</h5>
                                <small class="text-muted">Levels Completed</small>
                            </div>
                            <div class="col-6">
                                <h5 id="totalLevels" class="text-primary">7</h5>
                                <small class="text-muted">Total Levels</small>
                            </div>
                        </div>
                        <div class="progress mt-3">
                            <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.game-board-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 20px 0;
}

.level-indicator {
    margin-bottom: 15px;
}

.level-badge {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 10px 20px;
    border-radius: 25px;
    font-weight: bold;
    font-size: 1.2em;
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
    display: inline-block;
    border: 2px solid rgba(255, 255, 255, 0.3);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
}

.game-board {
    display: grid;
    grid-template-columns: repeat(9, 1fr);
    gap: 2px;
    background: #ddd;
    padding: 10px;
    border-radius: 8px;
    max-width: 500px;
    margin: 0 auto;
}

.cell {
    width: 40px;
    height: 40px;
    border: 1px solid #999;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s;
    background: #f8f9fa;
}

.cell:hover {
    background: #e9ecef;
}

.cell.marble {
    background: #007bff;
    border-radius: 50%;
    color: white;
    font-weight: bold;
}

.cell.selected {
    background: #28a745;
    border: 2px solid #20c997;
}

.cell.valid-move {
    background: #ffc107;
    border: 2px solid #fd7e14;
}

.cell.invalid {
    background-color: #6c757d !important;
    cursor: not-allowed !important;
    opacity: 0.6 !important;
    border-color: #495057 !important;
}

.config-item {
    padding: 10px;
    margin: 5px 0;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.2s;
}

.config-item:hover {
    background: #f8f9fa;
    border-color: #007bff;
}

.config-item.active {
    background: #007bff;
    color: white;
    border-color: #0056b3;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    transform: translateY(-1px);
}

.config-item.completed {
    border-color: #28a745;
    background: #f8fff9;
}

.config-item.completed:hover {
    background: #e8f5e8;
    border-color: #20c997;
}

.move-history {
    max-height: 200px;
    overflow-y: auto;
}

.move-item {
    padding: 5px;
    margin: 2px 0;
    background: #f8f9fa;
    border-radius: 3px;
    font-size: 0.9em;
}

@media (max-width: 768px) {
    .game-board {
        max-width: 100%;
    }
    
    .cell {
        width: 30px;
        height: 30px;
        font-size: 0.8em;
    }
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}
</style>

<script>
class SkippingStonesGame {
    constructor() {
        this.board = this.createBoard();
        this.selectedMarble = null;
        this.moveHistory = [];
        this.currentConfig = 'level1';
        this.configurations = {};
        this.completedLevels = [];
        this.isUserLoggedIn = false;
        this.levelStates = {}; // Store state for each level
        this.init();
    }
    
    // Save current level state to session storage
    saveLevelState() {
        const levelState = {
            board: this.board,
            moveHistory: this.moveHistory,
            currentConfig: this.currentConfig
        };
        this.levelStates[this.currentConfig] = levelState;
        sessionStorage.setItem('skippingStonesLevelStates', JSON.stringify(this.levelStates));
    }
    
    // Load level state from session storage
    loadLevelState(configKey) {
        const savedStates = sessionStorage.getItem('skippingStonesLevelStates');
        if (savedStates) {
            try {
                this.levelStates = JSON.parse(savedStates);
                const levelState = this.levelStates[configKey];
                if (levelState) {
                    this.board = levelState.board;
                    this.moveHistory = levelState.moveHistory;
                    return true;
                }
            } catch (error) {
                console.error('Error loading level states:', error);
            }
        }
        return false;
    }
    
    // Clear level state (for reset functionality)
    clearLevelState(configKey) {
        if (this.levelStates[configKey]) {
            delete this.levelStates[configKey];
            sessionStorage.setItem('skippingStonesLevelStates', JSON.stringify(this.levelStates));
        }
    }
    
    // Clear all session storage
    clearSessionStorage() {
        sessionStorage.removeItem('skippingStonesLevelStates');
        this.levelStates = {};
        console.log('Cleared session storage');
    }
    
    createBoard() {
        const board = [];
        for (let i = 0; i < 9; i++) {
            board[i] = [];
            for (let j = 0; j < 9; j++) {
                board[i][j] = false; // false = no marble, true = marble
            }
        }
        return board;
    }
    
    async init() {
        await this.loadConfigurations();
        this.setupEventListeners();
        
        // Check if user is logged in and load their state
        await this.checkUserLoginStatus();
        
        if (this.isUserLoggedIn) {
            // For logged-in users, don't load from session storage - load from server
            await this.loadUserGameState();
        } else {
            // For non-logged-in users, load from session storage
            const savedStates = sessionStorage.getItem('skippingStonesLevelStates');
            if (savedStates) {
                try {
                    this.levelStates = JSON.parse(savedStates);
                } catch (error) {
                    console.error('Error loading level states:', error);
                    this.levelStates = {};
                }
            }
            
            // Try to load saved state for current level
            const hasSavedState = this.loadLevelState(this.currentConfig);
            if (hasSavedState) {
                this.updateDisplay();
                this.updateMoveHistory();
            } else {
                this.loadConfiguration(this.currentConfig);
            }
        }
        
        this.updateDisplay();
        this.highlightActiveConfiguration();
        this.updateUserStats();
        this.updateSaveButtonState();
    }
    
    async loadConfigurations() {
        try {
            const response = await fetch('/api/skipping-stones/configs');
            this.configurations = await response.json();
            this.renderConfigurations();
        } catch (error) {
            console.error('Failed to load configurations:', error);
        }
    }
    
    renderConfigurations() {
        const container = document.getElementById('configurations');
        container.innerHTML = '';
        
        Object.entries(this.configurations).forEach(([key, config]) => {
            const div = document.createElement('div');
            div.className = 'config-item';
            if (key === this.currentConfig) {
                div.classList.add('active');
            }
            
            // Add completed indicator
            const isCompleted = this.completedLevels.includes(key);
            const completedIcon = isCompleted ? '<i class="fas fa-check-circle text-success me-2"></i>' : '';
            const completedClass = isCompleted ? 'completed' : '';
            
            div.innerHTML = `
                ${completedIcon}<strong>${config.name}</strong><br>
                <small class="text-muted">${config.description}</small>
                ${isCompleted ? '<br><small class="text-success">✓ Completed</small>' : ''}
            `;
            
            if (completedClass) {
                div.classList.add(completedClass);
            }
            
            div.onclick = () => this.selectConfiguration(key);
            container.appendChild(div);
        });
    }
    
    selectConfiguration(configKey) {
        // If we're already on this configuration, don't reset the game
        if (this.currentConfig === configKey) {
            // Just update the active configuration highlight without resetting
            this.highlightActiveConfiguration();
            return;
        }
        
        // Save current level state before switching
        this.saveLevelState();
        
        // Switch to the new level
        this.currentConfig = configKey;
        
        // Try to load saved state for this level
        const hasSavedState = this.loadLevelState(configKey);
        
        if (hasSavedState) {
            // Use saved state
            this.updateDisplay();
            this.updateMoveHistory();
        } else {
            // Load fresh configuration
            this.loadConfiguration(configKey, true); // Don't clear history since we're loading fresh
        }
        
        // Update level indicator
        const levelNumber = configKey.replace('level', '');
        document.getElementById('currentLevel').textContent = levelNumber;
        
        // Update active configuration
        this.highlightActiveConfiguration();
        
        // Update user stats
        this.updateUserStats();
    }
    
    loadConfiguration(configKey, preserveHistory = false) {
        this.currentConfig = configKey;
        this.resetBoard();
        
        const config = this.configurations[configKey];
        if (config && config.marbles) {
            config.marbles.forEach(([row, col]) => {
                this.board[row][col] = true;
            });
        }
        
        this.updateDisplay();
        
        // Only clear history if not preserving it
        if (!preserveHistory) {
            this.clearHistory();
        }
        
        // Update level indicator
        const levelNumber = configKey.replace('level', '');
        document.getElementById('currentLevel').textContent = levelNumber;
        
        // Update active configuration
        this.highlightActiveConfiguration();
        
        // Save state if user is logged in
        if (this.isUserLoggedIn) {
            console.log('User is logged in, saving all levels state after config load...');
            // Save all levels state instead of just current level
            this.saveGame();
        }
        
        // Save level state
        console.log('Saving level state for current level after config load...');
        this.saveLevelState();
        
        // Update user stats
        this.updateUserStats();
    }
    
    resetBoard() {
        for (let i = 0; i < 9; i++) {
            for (let j = 0; j < 9; j++) {
                this.board[i][j] = false;
            }
        }
        this.selectedMarble = null;
    }
    
    setupEventListeners() {
        document.getElementById('saveBtn').onclick = () => this.saveGame();
        document.getElementById('resetBtn').onclick = () => this.resetGame();
        document.getElementById('undoBtn').onclick = () => this.undoMove();
    }
    
    renderBoard() {
        const boardElement = document.getElementById('gameBoard');
        boardElement.innerHTML = '';
        
        for (let i = 0; i < 9; i++) {
            for (let j = 0; j < 9; j++) {
                const cell = document.createElement('div');
                cell.className = 'cell';
                cell.dataset.row = i;
                cell.dataset.col = j;

                // If the cell is in the top left 3x3 square, make it invalid
                if (i < 3 && j < 3) {
                    cell.classList.add('invalid');
                }

                // If the cell is in the bottom right 3x3 square, make it invalid
                if (i > 5 && j > 5) {   
                    cell.classList.add('invalid');
                }

                // If the cell is in the top right 3x3 square, make it invalid
                if (i < 3 && j > 5) {
                    cell.classList.add('invalid');  
                }
                // If the cell is in the bottom left 3x3 square, make it invalid
                if (i > 5 && j < 3) {
                    cell.classList.add('invalid');
                }

                
                if (this.board[i][j]) {
                    cell.classList.add('marble');
                    cell.textContent = '●';
                }
                
                if (this.selectedMarble && this.selectedMarble.row === i && this.selectedMarble.col === j) {
                    cell.classList.add('selected');
                }
                
                if (this.isValidMove(i, j) && !this.board[i][j]) {
                    cell.classList.add('valid-move');
                }
                
                cell.onclick = () => this.handleCellClick(i, j);
                boardElement.appendChild(cell);
            }
        }
    }
    
    handleCellClick(row, col) {
        if (this.board[row][col]) {
            // Clicked on a marble - select it
            this.selectedMarble = { row, col };
        } else if (this.selectedMarble && this.isValidMove(row, col)) {
            // Clicked on a valid destination - make the move
            this.makeMove(this.selectedMarble.row, this.selectedMarble.col, row, col);
            this.selectedMarble = null;
        }
        
        this.updateDisplay();
    }
    
    isValidMove(toRow, toCol) {
        if (!this.selectedMarble) return false;
        
        const { row: fromRow, col: fromCol } = this.selectedMarble;
        
        // Check if it's a valid jump (2 spaces in any direction)
        const rowDiff = Math.abs(toRow - fromRow);
        const colDiff = Math.abs(toCol - fromCol);
        
        if ((rowDiff === 2 && colDiff === 0) || (rowDiff === 0 && colDiff === 2)) {
            // Check if there's a marble to jump over
            const jumpRow = fromRow + (toRow - fromRow) / 2;
            const jumpCol = fromCol + (toCol - fromCol) / 2;
            
            return this.board[jumpRow][jumpCol];
        }
        
        return false;
    }
    
    makeMove(fromRow, fromCol, toRow, toCol) {
        // Remove the jumped marble
        const jumpRow = fromRow + (toRow - fromRow) / 2;
        const jumpCol = fromCol + (toCol - fromCol) / 2;
        
        this.board[fromRow][fromCol] = false;
        this.board[jumpRow][jumpCol] = false;
        this.board[toRow][toCol] = true;
        
        // Record the move
        this.moveHistory.push({
            from: { row: fromRow, col: fromCol },
            to: { row: toRow, col: toCol },
            jumped: { row: jumpRow, col: jumpCol }
        });
        
        this.updateMoveHistory();
        this.checkGameStatus();
        
        // Save state if user is logged in
        if (this.isUserLoggedIn) {
            console.log('User is logged in, saving all levels state...');
            // Save all levels state instead of just current level
            this.saveGame();
        }
        
        // Save level state
        console.log('Saving level state for current level...');
        this.saveLevelState();
        
        // Update user stats
        this.updateUserStats();
    }
    
    updateDisplay() {
        this.renderBoard();
        this.updateStats();
    }
    
    updateStats() {
        const marblesLeft = this.countMarbles();
        const movesCount = this.moveHistory.length;
        
        document.getElementById('marblesLeft').textContent = marblesLeft;
        document.getElementById('movesCount').textContent = movesCount;
        
        let status = 'Playing';
        if (marblesLeft === 1) {
            status = 'Won!';
        } else if (marblesLeft > 1 && !this.hasValidMoves()) {
            status = 'Stuck';
        }
        
        document.getElementById('gameStatus').textContent = status;
    }
    
    countMarbles() {
        let count = 0;
        for (let i = 0; i < 9; i++) {
            for (let j = 0; j < 9; j++) {
                if (this.board[i][j]) count++;
            }
        }
        return count;
    }
    
    hasValidMoves() {
        for (let i = 0; i < 9; i++) {
            for (let j = 0; j < 9; j++) {
                if (this.board[i][j]) {
                    // Check if this marble can make any valid moves
                    const directions = [[-2, 0], [2, 0], [0, -2], [0, 2]];
                    for (const [dRow, dCol] of directions) {
                        const toRow = i + dRow;
                        const toCol = j + dCol;
                        if (toRow >= 0 && toRow < 9 && toCol >= 0 && toCol < 9) {
                            if (!this.board[toRow][toCol]) {
                                const jumpRow = i + dRow / 2;
                                const jumpCol = j + dCol / 2;
                                if (this.board[jumpRow][jumpCol]) {
                                    return true;
                                }
                            }
                        }
                    }
                }
            }
        }
        return false;
    }
    
    checkGameStatus() {
        const marblesLeft = this.countMarbles();
        if (marblesLeft === 1) {
            // Game won - mark level as completed
            if (this.isUserLoggedIn) {
                this.markLevelCompleted(this.currentConfig);
            }
        } else if (marblesLeft > 1 && !this.hasValidMoves()) {
            // Game stuck - status will be updated in updateStats
        }
    }
    
    updateMoveHistory() {
        const container = document.getElementById('moveHistory');
        container.innerHTML = '';
        
        if (this.moveHistory.length === 0) {
            container.innerHTML = '<p class="text-muted text-center">No moves yet</p>';
            return;
        }
        
        this.moveHistory.forEach((move, index) => {
            const div = document.createElement('div');
            div.className = 'move-item';
            div.textContent = `Move ${index + 1}: (${move.from.row},${move.from.col}) → (${move.to.row},${move.to.col})`;
            container.appendChild(div);
        });
        
        container.scrollTop = container.scrollHeight;
    }
    
    resetGame() {
        // Remove current level from completed levels if it was completed
        if (this.completedLevels.includes(this.currentConfig)) {
            this.completedLevels = this.completedLevels.filter(level => level !== this.currentConfig);
            console.log(`Removed ${this.currentConfig} from completed levels`);
        }
        
        // Clear the level state for current level
        this.clearLevelState(this.currentConfig);
        this.loadConfiguration(this.currentConfig);
        
        // Update user stats
        this.updateUserStats();
    }
    
    undoMove() {
        if (this.moveHistory.length === 0) return;
        
        const lastMove = this.moveHistory.pop();
        
        // Restore the board state
        this.board[lastMove.from.row][lastMove.from.col] = true;
        this.board[lastMove.jumped.row][lastMove.jumped.col] = true;
        this.board[lastMove.to.row][lastMove.to.col] = false;
        
        this.selectedMarble = null;
        this.updateDisplay();
        this.updateMoveHistory();
        
        // Save state if user is logged in
        if (this.isUserLoggedIn) {
            console.log('User is logged in, saving all levels state after undo...');
            // Save all levels state instead of just current level
            this.saveGame();
        }
        
        // Save level state
        console.log('Saving level state for current level after undo...');
        this.saveLevelState();
        
        // Update user stats
        this.updateUserStats();
    }
    
    clearHistory() {
        this.moveHistory = [];
        this.updateMoveHistory();
    }
    
    highlightActiveConfiguration() {
        // Remove active class from all config items
        document.querySelectorAll('.config-item').forEach(item => {
            item.classList.remove('active');
        });
        
        // Add active class to the current configuration
        const configItems = document.querySelectorAll('.config-item');
        configItems.forEach((item, index) => {
            const configKey = Object.keys(this.configurations)[index];
            if (configKey === this.currentConfig) {
                item.classList.add('active');
            }
        });
    }
    
    async checkUserLoginStatus() {
        try {
            // Check if user is logged in using the auth status endpoint
            const response = await fetch('/api/auth/status');
            if (response.ok) {
                const authData = await response.json();
                this.isUserLoggedIn = authData.authenticated;
            } else {
                this.isUserLoggedIn = false;
            }
        } catch (error) {
            this.isUserLoggedIn = false;
        }
        this.updateSaveButtonState();
    }
    
    async loadUserGameState() {
        try {
            console.log('Loading user game state...');
            
            // Try to load all levels state first
            const allLevelsResponse = await fetch('/api/game-state/load-all-levels');
            console.log('All levels response status:', allLevelsResponse.status);
            
            if (allLevelsResponse.ok) {
                const allLevelsState = await allLevelsResponse.json();
                console.log('All levels state received:', allLevelsState);
                console.log('Raw level_states:', allLevelsState.level_states);
                console.log('Type of level_states:', typeof allLevelsState.level_states);
                
                // Load all levels state from server
                const serverLevelStates = allLevelsState.level_states || {};
                this.completedLevels = allLevelsState.completed_levels || [];
                this.currentConfig = allLevelsState.current_level || 'level1';
                
                // For logged-in users, use server data directly (don't merge with session storage)
                this.levelStates = serverLevelStates;
                
                console.log('Server levelStates:', serverLevelStates);
                console.log('Final levelStates:', this.levelStates);
                console.log('Loaded completedLevels:', this.completedLevels);
                console.log('Current config:', this.currentConfig);
                console.log('Keys in levelStates:', Object.keys(this.levelStates));
                
                // Load current level state
                const currentLevelState = this.levelStates[this.currentConfig];
                console.log('Current level state:', currentLevelState);
                console.log('Looking for level:', this.currentConfig);
                console.log('Available levels in levelStates:', Object.keys(this.levelStates));
                
                if (currentLevelState) {
                    console.log('Loading board state:', currentLevelState.board);
                    console.log('Loading move history:', currentLevelState.moveHistory);
                    this.board = currentLevelState.board;
                    this.moveHistory = currentLevelState.moveHistory || [];
                    this.updateDisplay();
                    this.updateMoveHistory();
                    console.log('Loaded saved state for current level');
                } else {
                    // Load fresh configuration for current level
                    console.log('No saved state for current level, loading fresh config');
                    this.loadConfiguration(this.currentConfig, true);
                }
                
                // Update level indicator
                const levelNumber = this.currentConfig.replace('level', '');
                document.getElementById('currentLevel').textContent = levelNumber;
                
                // Update active configuration
                this.highlightActiveConfiguration();
                
                console.log('Successfully loaded all levels state');
            } else {
                console.log('All levels load failed, trying fallback...');
                // Fallback to old single level loading
                const response = await fetch('/api/game-state/load');
                if (response.ok) {
                    const gameState = await response.json();
                    
                    // Load the saved state
                    this.currentConfig = gameState.current_level || 'level1';
                    this.completedLevels = gameState.completed_levels || [];
                    
                    // Load board state if it exists
                    if (gameState.board_state && gameState.board_state.length > 0) {
                        this.board = gameState.board_state;
                        // Load move history
                        this.moveHistory = gameState.move_history || [];
                        // Update the move history display
                        this.updateMoveHistory();
                        // Update display without clearing history
                        this.updateDisplay();
                        this.highlightActiveConfiguration();
                        
                        // Update level indicator
                        const levelNumber = this.currentConfig.replace('level', '');
                        document.getElementById('currentLevel').textContent = levelNumber;
                    } else {
                        this.loadConfiguration(this.currentConfig);
                    }
                    
                    console.log('Loaded user game state:', gameState);
                } else {
                    // If no saved state, load default configuration
                    this.loadConfiguration(this.currentConfig);
                }
            }
        } catch (error) {
            console.error('Error loading user game state:', error);
            this.loadConfiguration(this.currentConfig);
        }
    }
    
    async saveGameState() {
        if (!this.isUserLoggedIn) return;
        
        try {
            const gameState = {
                current_level: this.currentConfig,
                board_state: this.board,
                move_history: this.moveHistory,
                marbles_left: this.countMarbles(),
                moves_count: this.moveHistory.length,
                game_status: this.getGameStatus(),
                completed_levels: this.completedLevels
            };
            
            const response = await fetch('/api/game-state/save', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(gameState)
            });
            
            if (response.ok) {
                console.log('Game state saved successfully');
            } else {
                console.error('Failed to save game state');
            }
        } catch (error) {
            console.error('Error saving game state:', error);
        }
    }
    
    async saveGame() {
        if (!this.isUserLoggedIn) {
            alert('Please log in to save your game progress.');
            return;
        }
        
        try {
            console.log('Before saving - levelStates:', this.levelStates);
            console.log('Current config:', this.currentConfig);
            console.log('Current board:', this.board);
            console.log('Current moveHistory:', this.moveHistory);
            
            // Make sure current level state is included in levelStates
            this.levelStates[this.currentConfig] = {
                board: this.board,
                moveHistory: this.moveHistory,
                currentConfig: this.currentConfig
            };
            
            console.log('After adding current level - levelStates:', this.levelStates);
            
            // Save all levels state
            const allLevelsState = {
                level_states: this.levelStates,
                completed_levels: this.completedLevels,
                current_level: this.currentConfig
            };
            
            console.log('Saving all levels state:', allLevelsState);
            
            const response = await fetch('/api/game-state/save-all-levels', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(allLevelsState)
            });
            
            console.log('Save response status:', response.status);
            
            if (response.ok) {
                console.log('All levels state saved successfully');
                // Show success feedback
                const saveBtn = document.getElementById('saveBtn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-check me-2"></i>Saved!';
                saveBtn.classList.remove('btn-success');
                saveBtn.classList.add('btn-success');
                
                // Reset button text after 2 seconds
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                }, 2000);
            } else {
                const errorText = await response.text();
                console.error('Failed to save all levels state:', errorText);
                alert('Failed to save game. Please try again.');
            }
        } catch (error) {
            console.error('Error saving game:', error);
            alert('Failed to save game. Please try again.');
        }
    }
    
    async markLevelCompleted(level) {
        if (!this.isUserLoggedIn) return;
        
        try {
            const response = await fetch('/api/game-state/complete-level', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ level: level })
            });
            
            if (response.ok) {
                if (!this.completedLevels.includes(level)) {
                    this.completedLevels.push(level);
                }
                console.log(`Level ${level} marked as completed`);
            } else {
                console.error('Failed to mark level as completed');
            }
        } catch (error) {
            console.error('Error marking level as completed:', error);
        }
    }
    
    getGameStatus() {
        const marblesLeft = this.countMarbles();
        if (marblesLeft === 1) {
            return 'Won!';
        } else if (marblesLeft > 1 && !this.hasValidMoves()) {
            return 'Stuck';
        }
        return 'Playing';
    }
    
    updateUserStats() {
        if (!this.isUserLoggedIn) {
            document.getElementById('userStatsCard').style.display = 'none';
            return;
        }
        
        // Only show user stats if the user is actually logged in
        document.getElementById('userStatsCard').style.display = 'block';
        const completedCount = this.completedLevels.length;
        const totalLevels = 7;
        const progressPercentage = (completedCount / totalLevels) * 100;
        
        document.getElementById('completedLevels').textContent = completedCount;
        document.getElementById('totalLevels').textContent = totalLevels;
        document.getElementById('progressBar').style.width = `${progressPercentage}%`;
        document.getElementById('progressBar').setAttribute('aria-valuenow', progressPercentage);
    }
    
    updateSaveButtonState() {
        const saveBtn = document.getElementById('saveBtn');
        if (!this.isUserLoggedIn) {
            saveBtn.disabled = true;
            saveBtn.title = 'Please log in to save your game';
        } else {
            saveBtn.disabled = false;
            saveBtn.title = 'Save progress for all levels';
        }
    }
}

// Initialize the game when the page loads
document.addEventListener('DOMContentLoaded', () => {
    const game = new SkippingStonesGame();
    
    // Add logout handler to clear session storage
    window.addEventListener('beforeunload', () => {
        // Clear session storage when page is unloaded (logout or navigation)
        if (game.isUserLoggedIn) {
            game.clearSessionStorage();
        }
    });
    
    // Add click handler for logout link
    const logoutLink = document.querySelector('a[href*="logout"]');
    if (logoutLink) {
        logoutLink.addEventListener('click', () => {
            if (game.isUserLoggedIn) {
                game.clearSessionStorage();
            }
        });
    }
});
</script>
{% endblock %} 